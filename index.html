<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mixhup Store — Final SPA</title>
<style>
  :root{
    --bg:#0f0f0f; --panel:#151515; --card:#1a1a1a; --muted:#bbb; --accent1:#ff4d4d; --accent2:#ff9999;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:Inter, system-ui, Arial, sans-serif}
  header{background:var(--panel);padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 8px 30px rgba(255,77,77,0.06)}
  header h1{margin:0;color:var(--accent1);letter-spacing:1px}
  nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  nav a{color:#fff;text-decoration:none;cursor:pointer;padding:8px 10px;border-radius:8px;font-weight:600}
  nav a:hover{color:var(--accent2);text-shadow:0 0 8px rgba(255,77,77,0.15)}
  .btn{background:linear-gradient(45deg,var(--accent1),var(--accent2));border:0;color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(255,77,77,0.12);transition:transform .14s,box-shadow .14s}
  .btn:hover{transform:translateY(-3px);box-shadow:0 18px 40px rgba(255,77,77,0.18)}
  .small{padding:4px 8px;font-size:13px}
  .page{display:none;padding:22px;min-height:calc(100vh - 72px)}
  .flex-center{display:flex;align-items:center;justify-content:center}
  .products-container{display:flex;flex-wrap:wrap;gap:16px;justify-content:center}
  .product-card{width:220px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4);text-align:center}
  .product-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px}
  .price-old{color:var(--muted);text-decoration:line-through;margin-left:6px;font-size:13px}
  .price-new{color:var(--accent1);font-weight:800}
  .color-row{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:8px 0}
  .color-btn{padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;cursor:pointer;font-size:13px}
  .color-btn.selected{box-shadow:0 0 12px rgba(255,77,77,0.25)}
  input[type=number]{width:80px;padding:6px;border-radius:6px;border:0;background:#0e0e0e;color:#fff}
  .cart-item{display:flex;align-items:center;gap:10px;background:var(--card);padding:10px;border-radius:10px;margin:8px 0;width:100%;max-width:760px}
  .cart-item img{width:70px;height:70px;object-fit:cover;border-radius:8px}
  .cart-item .meta{flex:1;text-align:left}
  .cart-buttons{display:flex;gap:12px;justify-content:center;margin-top:12px}
  .pay-btn{padding:8px 14px;border-radius:10px;border:0;background:linear-gradient(45deg,var(--accent1),var(--accent2));cursor:pointer;font-weight:800}
  .card{background:var(--card);padding:16px;border-radius:12px;max-width:420px;margin:12px auto}
  input[type=email],input[type=password],input[type=text]{width:100%;padding:10px;border-radius:8px;border:0;background:#0e0e0e;color:#fff;margin:8px 0}
  label.rem{display:flex;align-items:center;gap:8px;color:#ddd;font-size:14px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:9999}
  .modal .box{background:var(--panel);padding:18px;border-radius:12px;max-width:520px;width:92%;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
  .close-x{position:absolute;top:10px;left:10px;background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
  .toast{position:fixed;bottom:22px;left:22px;background:var(--accent1);padding:10px 14px;border-radius:8px;color:#fff;font-weight:700;z-index:10000}
  .category-btn{padding:4px 10px;border-radius:6px;border:1px solid var(--accent1);cursor:pointer;background:transparent;color:#fff;margin:4px;font-size:13px}
  .category-btn.selected{background:var(--accent1);color:#000}
  @media(max-width:700px){.product-card{width:46%}.cart-item{flex-direction:column;align-items:flex-start}.product-card img{height:120px}}
  @media(max-width:420px){.product-card{width:100%}}
</style>
</head>
<body>

<header>
  <h1>Mixhup Store</h1>
  <nav>
    <a onclick="showPage('index')">المتجر</a>
    <a onclick="showPage('cart')">عربة التسوق</a>
    <a onclick="showPage('admin')">لوحة التحكم</a>
    <a id="login-btn" onclick="showPage('login')">تسجيل دخول</a>
  </nav>
</header>

<section id="page-login" class="page">
  <div class="card">
    <h2>تسجيل دخول</h2>
    <input id="user-email" type="email" placeholder="البريد الإلكتروني" />
    <input id="user-pass" type="password" placeholder="كلمة المرور" />
    <label class="rem"><input id="remember-me" type="checkbox" /> حفظ الحساب</label>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
      <button class="btn" onclick="userLogin()">دخول</button>
      <button class="btn small" onclick="showPage('register')">سجل هنا</button>
    </div>
  </div>
</section>

<section id="page-register" class="page">
  <div class="card">
    <h2>تسجيل جديد</h2>
    <input id="reg-email" type="email" placeholder="البريد الإلكتروني" />
    <input id="reg-pass" type="password" placeholder="كلمة المرور" />
    <label class="rem"><input id="reg-remember-me" type="checkbox" /> حفظ الحساب</label>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
      <button class="btn" onclick="userRegister()">سجل</button>
      <button class="btn small" onclick="showPage('login')">لدي حساب</button>
    </div>
  </div>
</section>

<section id="page-index" class="page">
  <div style="max-width:1100px;margin:0 auto">
    <div id="categories" class="flex-center" style="flex-wrap:wrap;margin-bottom:12px"></div>
    <div id="products" class="products-container"></div>
  </div>
</section>

<section id="page-cart" class="page">
  <div style="max-width:980px;margin:0 auto;display:flex;flex-direction:column;align-items:center">
    <div id="cart-items" style="width:100%"></div>
    <h3 id="total-price">الإجمالي: 0 جنيه</h3>
    <div class="cart-buttons">
      <button class="pay-btn" onclick="openModal('whatsapp')">واتساب</button>
      <button class="pay-btn" onclick="openModal('vodafone')">فودافون كاش</button>
      <button class="pay-btn" onclick="openModal('instapay')">إنستا باي</button>
    </div>
  </div>
</section>

<section id="page-admin" class="page">
  <div class="card">
    <h2>لوحة التحكم - إضافة منتج</h2>
    <input id="prod-name" type="text" placeholder="اسم المنتج" />
    <input id="prod-price" type="number" placeholder="السعر بعد الخصم" />
    <input id="prod-price-old" type="number" placeholder="السعر قبل الخصم (اختياري)" />
    <input id="prod-colors" type="text" placeholder="الألوان (مثال: أحمر,أزرق)" />
    <input id="prod-category" type="text" placeholder="القسم (مثال: إلكترونيات)" />
    <input id="prod-image" type="text" placeholder="رابط الصورة" />
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
      <button class="btn" onclick="addProduct()">إضافة</button>
      <button class="btn small" onclick="logoutAdmin()">تسجيل خروج</button>
    </div>
    <h3 style="margin-top:18px">المنتجات الحالية</h3>
    <div id="admin-products" class="products-container"></div>
  </div>
</section>

<div id="modal-whatsapp" class="modal"><div class="box">
  <button class="close-x" onclick="closeModal('whatsapp')">✕</button>
  <h3>دفع واتساب</h3>
  <p>اضغط فتح واتساب لإرسال رسالة الطلب إلى <strong id="wa-number">+20 1122831032</strong></p>
  <div style="margin-top:10px"><button class="btn" id="wa-btn">افتح واتساب</button></div>
</div></div>

<div id="modal-vodafone" class="modal"><div class="box">
  <button class="close-x" onclick="closeModal('vodafone')">✕</button>
  <h3>دفع فودافون كاش</h3>
  <p>رقم الدفع: <strong id="vod-number">+20 1122831032</strong></p>
  <div style="margin-top:10px"><button class="btn" onclick="copyText('vod-number')">نسخ الرقم</button></div>
</div></div>

<div id="modal-instapay" class="modal"><div class="box">
  <button class="close-x" onclick="closeModal('instapay')">✕</button>
  <h3>دفع إنستا باي</h3>
  <p id="insta-instr">رقم: <strong>+20 1122831032</strong> — اتبع التعليمات في التطبيق.</p>
  <div style="margin-top:10px"><button class="btn" onclick="copyText('insta-instr')">نسخ التعليمات</button></div>
</div></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyALEz_Sjcx2ikhNrRRhKRzyVLWdcQf03_I",
  authDomain: "mixhup-store-eff4c.firebaseapp.com",
  databaseURL: "https://mixhup-store-eff4c-default-rtdb.firebaseio.com",
  projectId: "mixhup-store-eff4c",
  storageBucket: "mixhup-store-eff4c.appspot.com",
  messagingSenderId: "1024483166692",
  appId: "1:1024483166692:web:1d6c39a212f323c1d19ff1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const pages = {
  index: document.getElementById('page-index'),
  cart: document.getElementById('page-cart'),
  admin: document.getElementById('page-admin'),
  login: document.getElementById('page-login'),
  register: document.getElementById('page-register')
};
const loginBtn = document.getElementById('login-btn');
const ADMIN_EMAIL = 'mixhupstore8@gmail.com';

let currentCategory = 'الكل';

function showPage(name){
  for(const k in pages) pages[k].style.display = 'none';
  
  if(name === 'admin'){
    const user = auth.currentUser;
    if(!user || user.email !== ADMIN_EMAIL){
      showToast('غير مصرح بالدخول للوحة التحكم');
      pages.login.style.display = 'block';
      loginBtn.style.display = 'inline-block';
      return;
    }
    pages.admin.style.display = 'block';
    return;
  }

  if(name === 'index' || name === 'cart') pages[name].style.display = 'flex';
  else pages[name].style.display = 'block';

  loginBtn.style.display = auth.currentUser ? 'none' : 'inline-block';
}

function showToast(msg){
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 2800);
}

function copyText(id){
  const txt = document.getElementById(id).innerText || document.getElementById(id).textContent;
  navigator.clipboard.writeText(txt).then(()=> showToast('تم النسخ'));
}

function openModal(type){
  if(type==='whatsapp'){
    prepareWhatsappButton();
    document.getElementById('modal-whatsapp').style.display = 'flex';
  } else if(type==='vodafone') document.getElementById('modal-vodafone').style.display = 'flex';
  else if(type==='instapay') document.getElementById('modal-instapay').style.display = 'flex';
}
function closeModal(type){ document.getElementById('modal-'+type).style.display = 'none'; }

let productsCache = {};
const productsContainer = document.getElementById('products');
const adminProducts = document.getElementById('admin-products');
const categoriesDiv = document.getElementById('categories');

function renderCategories(data){
  const allCats = new Set(['الكل']);
  for(const id in data) if(data[id].category) allCats.add(data[id].category);
  categoriesDiv.innerHTML = '';
  allCats.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className='category-btn'+(cat===currentCategory?' selected':'');
    btn.innerText = cat;
    btn.onclick = ()=> { currentCategory=cat; renderProductsList(productsCache); renderCategories(productsCache); };
    categoriesDiv.appendChild(btn);
  });
}

function renderProductsList(data){
  productsCache = data;
  productsContainer.innerHTML = '';
  for(const id in data){
    const p = data[id];
    if(currentCategory!=='الكل' && p.category!==currentCategory) continue;
    const colors = p.colors ? p.colors.split(',').map(s=>s.trim()).filter(Boolean) : [];
    const card = document.createElement('div'); card.className = 'product-card';
    card.innerHTML = `
      <img src="${escapeHtml(p.image||'')}" alt="${escapeHtml(p.name||'')}">
      <h3>${escapeHtml(p.name||'')}</h3>
      <p>
        <span class="price-old">${p.priceOld ? (p.priceOld + ' جنيه') : ''}</span>
        <span class="price-new">${p.price} جنيه</span>
      </p>
      <div class="color-row">${colors.map(c=>`<button class="color-btn" onclick="selectColor('${id}','${escapeHtml(c)}',this)">${escapeHtml(c)}</button>`).join('')}</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <input type="number" id="qty-${id}" min="1" value="1">
        <button class="btn small" onclick="addToCart('${id}')">أضف للعربة</button>
      </div>
    `;
    productsContainer.appendChild(card);
  }

  // لوحة الإدارة
  adminProducts.innerHTML = '';
  for(const id in data){
    const p = data[id];
    const div = document.createElement('div'); div.className='product-card';
    div.style.width='180px';
    div.innerHTML = `<img src="${escapeHtml(p.image||'')}" alt="${escapeHtml(p.name||'')}"><h4>${escapeHtml(p.name||'')}</h4><p>${p.price} جنيه</p><div style="display:flex;gap:6px;justify-content:center"><button class="btn small" onclick="deleteProduct('${id}')">حذف</button></div>`;
    adminProducts.appendChild(div);
  }

  renderCategories(data);
}

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

db.ref('products').on('value', snap=>{
  const data = snap.val() || {};
  renderProductsList(data);
});

let cart = {};
let selectedColors = {};

function selectColor(productId, color, btnEl){
  selectedColors[productId] = color;
  const parent = btnEl.parentElement;
  parent.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('selected'));
  btnEl.classList.add('selected');
}

function addToCart(id){
  const qtyInput = document.getElementById(`qty-${id}`);
  const qty = Math.max(1, parseInt(qtyInput?.value || 1));
  const color = selectedColors[id] || '';
  const p = productsCache[id];
  if(!p){ showToast('خطأ: المنتج غير موجود'); return; }
  if(cart[id]) cart[id].quantity += qty;
  else cart[id] = { id, quantity: qty, color, name: p.name, price: p.price };
  loadCart();
  showToast('تم الإضافة للعربة');
}

function loadCart(){
  const ctr = document.getElementById('cart-items');
  ctr.innerHTML = '';
  let total = 0;
  for(const id in cart){
    const item = cart[id];
    const p = productsCache[id];
    if(p){ item.name = p.name; item.price = p.price; }
    total += (item.price || 0) * item.quantity;
        const div = document.createElement('div'); div.className='cart-item';
    div.innerHTML = `
      <img src="${escapeHtml((productsCache[id]?.image)||'')}" alt="${escapeHtml(item.name)}" />
      <div class="meta">
        <div style="font-weight:800">${escapeHtml(item.name)} ${item.color? ' ('+escapeHtml(item.color)+')':''}</div>
        <div style="color:var(--muted)">${item.price} جنيه × ${item.quantity} = ${(item.price*item.quantity)} جنيه</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div>
          <button class="small btn" onclick="changeQty('${id}',-1)">−</button>
          <button class="small btn" onclick="changeQty('${id}',1)">+</button>
        </div>
        <button class="small" onclick="removeItem('${id}')">حذف</button>
      </div>
    `;
    ctr.appendChild(div);
  }
  document.getElementById('total-price').innerText = 'الإجمالي: ' + total + ' جنيه';
}

function changeQty(id, delta){
  if(!cart[id]) return;
  cart[id].quantity = Math.max(1, cart[id].quantity + delta);
  loadCart();
}

function removeItem(id){ delete cart[id]; loadCart(); showToast('تم الحذف'); }

const PAY_NUMBER = '+201122831032';

function prepareWhatsappButton(){
  const btn = document.getElementById('wa-btn');
  btn.onclick = async ()=>{
    let msg = 'طلب شراء من Mixhup Store:%0A';
    let total = 0;
    for(const id in cart){
      const it = cart[id];
      msg += `${it.quantity} x ${escapeForUrl(it.name)} ${it.color? '('+escapeForUrl(it.color)+')':''} - ${it.price} جنيه%0A`;
      total += (it.price || 0) * it.quantity;
    }
    msg += `الإجمالي: ${total} جنيه%0A`;
    window.open('https://wa.me/' + PAY_NUMBER.replace(/\D/g,'') + '?text=' + msg, '_blank');
  };
}
function escapeForUrl(s){ if(!s) return ''; return encodeURIComponent(s); }

function userLogin(){
  const email = document.getElementById('user-email').value.trim();
  const pass  = document.getElementById('user-pass').value.trim();
  const remember = document.getElementById('remember-me').checked;
  if(!email || !pass){ showToast('اكمل البيانات'); return; }
  auth.signInWithEmailAndPassword(email, pass)
    .then(()=> {
      loginBtn.style.display = 'none';
      if(remember) localStorage.setItem('savedUser', JSON.stringify({email,pass}));
      else localStorage.removeItem('savedUser');
      showPage('index');
      showToast('تم تسجيل الدخول');
    })
    .catch(err=> showToast(err.message));
}

function userRegister(){
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-pass').value.trim();
  const remember = document.getElementById('reg-remember-me').checked;
  if(!email || !pass){ showToast('اكمل البيانات'); return; }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(()=> {
      loginBtn.style.display = 'none';
      if(remember) localStorage.setItem('savedUser', JSON.stringify({email,pass}));
      else localStorage.removeItem('savedUser');
      showPage('index');
      showToast('تم إنشاء الحساب وتسجيل الدخول');
    })
    .catch(err=> showToast(err.message));
}

window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('savedUser');
  if(saved){
    try{
      const {email,pass} = JSON.parse(saved);
      if(email && pass){
        auth.signInWithEmailAndPassword(email, pass)
          .then(()=> { showPage('index'); loginBtn.style.display='none'; })
          .catch(()=> { localStorage.removeItem('savedUser'); showPage('login'); loginBtn.style.display='inline-block' });
        return;
      }
    }catch(e){ localStorage.removeItem('savedUser'); }
  }
  showPage('login');
});

auth.onAuthStateChanged(user=>{ loginBtn.style.display = user ? 'none' : 'inline-block'; });

function addProduct(){
  const name = document.getElementById('prod-name').value.trim();
  const price = parseFloat(document.getElementById('prod-price').value);
  const priceOld = parseFloat(document.getElementById('prod-price-old').value) || null;
  const colors = document.getElementById('prod-colors').value.trim();
  const category = document.getElementById('prod-category').value.trim();
  const image = document.getElementById('prod-image').value.trim();
  if(!name || !price || !image || !category){ showToast('اكمل الحقول المطلوبة'); return; }
  const newRef = db.ref('products').push();
  newRef.set({ name, price, priceOld, colors, category, image })
    .then(()=> {
      showToast('تم إضافة المنتج');
      document.getElementById('prod-name').value=''; document.getElementById('prod-price').value=''; document.getElementById('prod-price-old').value=''; document.getElementById('prod-colors').value=''; document.getElementById('prod-category').value=''; document.getElementById('prod-image').value='';
    })
    .catch(e=> showToast('خطأ: ' + e.message));
}

function deleteProduct(id){
  if(!confirm('متأكد من حذف المنتج؟')) return;
  db.ref('products/'+id).remove().then(()=> showToast('تم الحذف')).catch(e=> showToast('خطأ: '+e.message));
}

function logoutAdmin(){
  auth.signOut().then(()=> { showPage('login'); showToast('تم تسجيل الخروج'); }).catch(()=>{});
}

</script>
</body>
</html>
